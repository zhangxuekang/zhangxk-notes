# 营销

负责营销活动的相关配置页面，包括营销活动，和各种营销资源位。
页面主要是由表单和列表构成。
项目是由 angular 写的，表单使用的 angular 的**响应式表单**特性，将表单抽象成**表单模型**，表单的行为都在这个**结构**里定义。列表使用 ng-zorro（Ant Design of Angular）为基础封装的自定义组件。
难点就是嵌套表单的数据处理，表单的联动校验，表单行为的联动等。

**营销活动**，**营销资源位**。

配置活动，圈定用户，活动内容。

资源位内容，圈定用户，用户分组。

资源位表单内容配置，增加一种资源位由之前的重新开发一套增删改查页面，到产品只需要增加一种配置即可。

展示地区、用户年级、科目、展示时间、设备信息。

图片，位置，标签，落地页链接，背景图片，小程序链接。

**模板驱动表单**和**响应式表单**，使用响应式表单设置。

响应式表单将表单抽象成表单模型，表单的行为都在这个结构里定义。每个表单项都是一个 formControl，还可以设置 formGroup，作为子表单。重要的表单校验以函数的形式作为表单结构的属性。

多层嵌套表单，联动逻辑，联动校验。

# 屏幕录制工具与回放平台

工具用来录制站内用户的操作视频，用于获取用户**操作现场**，**定位与复现系统问题**，获取用户真实行为数据，降低产品调研成本。
封装 RRWeb 开源录制库(并非录制视频,实际录制信息变更时间流)
项目分为 录制 SDK + 回放 replayer 站点+ 服务器 server
用户在初始化站内页面的时候，会进行录制工具的初始化。开始录制，保存在用户本地，浏览器的 indexDB 里，只保留最近两天的数据。
在 replayer 侧进行查询数据拉取，通过服务器上传到数据库，就可以在播放器看到数据，进行播放。

server：使用 node 命令部署启动，暂时没有切换到 pm2，公司内部不支持。内部 console 部署平台。

## web 录制解决方案

### 视频流

- MediaRecorder Api 浏览器录屏 api,媒体流数据
- HTML to Canvas 固定频率截图,模拟录制

优点:

支持复杂元素,canvas,video
支持多标签

缺点:

消耗高
只能录制屏幕显示数据
用户操作成本高(授权等)
兼容性差(ie,安卓)

### 事件流

- user event record 录制用户操作事件,沙箱模拟回放
- UI event record 录制浏览器信息变更(dom css),沙箱模拟回放

优点:

产物体积小
性能消耗小,用户无感知
支持窗口最大化,最小化,全屏等

缺点:

复杂元素差
tab 页面刷新后录制中断

## rrweb 原理

### 记录

- 将 dom 及其状态转化为可序列化的数据结构 snapshot dom-vdom
  - html-json
  - 表单值写成 html 属性
  - script 标签改成 noscript,避免意外执行 js
  - 样式内联
  - ...
- 监听增量更新
  - 类型
    - dom mutation
    - input event
      - 不记录 password
    - mouse event
    - window event
    - ...
- 数据存储

### 回放

- 实例化
  - div 模拟鼠标
  - canvas 模拟鼠标轨迹
- rebuild dom
- 应用增量更新

# 初高测试相关

1. 初高测试相关业务分为模板项目和业务项目
2. 先说模板项目。模板项目提供的功能是渲染某一道题，试卷题目分为多种题型（单选，多选，填空，阅读理解等等），每种题型的数据结构是确定的。
3. 旧的模板项目。为每一种题型开发了一套渲染组件。这种情况效率低，增加一·种题型就得重新开发一套组件
4. 经过重构后的模板项目。将每种题型的结构进行分类（题干，选项，答案，解析，考点等等），每种结构开发一个组件，这样，组件就和具体的题型进行了解耦，根据不同题型选择组件拼装就行了。效率高，增加题型可能只需要选择不同组件拼装就可以了。使用插槽进行拼装布局。
5. 模板项目是整个公司都在使用，学生作答、老师组卷、批改试卷都需要。以公司内部 npm 包的的形式共享。
6. 业务项目是学生端作答和查看解析的页面。负责将一系列题目渲染成一套试卷，控制作答翻页，展示作答结果。业务项目引用了模板项目。
7. 初高测试分为不同的练习（课前预习，课中测试，课后作业，阶段测试等等），不同的练习功能大体相同，又有自己的逻辑。例如有的测试可以多次作答，有的测试只能作答一次。测试会运行在手机端，pad 端和 pc 端。
8. 旧的测试项目，将不用的练习分别开发了一套逻辑，互相不会影响；然后手机和 pad 是一个项目，pad 上展示的就是放大版的手机样式，pc 端的页面是另一个项目。增加一种新的测试类型的成本很高，需要在多个项目多次开发。
9. 经过重构后的项目。将每种练习细分成不同组件（翻页 swiper，答题卡，作答进度条，结果页各种组件等等），维护一个项目内部的公共组件库。同时每种组件 ui 适配不用的设备端。不同练习只需要引用各自的组件组合就行。重构后增加一种测试类型的成本很低，只需要增加一种配置就可以了，极大的提高的开发效率。

推进重构进行，技术项目，申请产品、ui、测试各方介入。暂时砍掉不是很紧急的业务需求。

难点：
结果页的动画，使用到了 canvas 和 svg 路径动画。
不同端的样式兼容（rem+flex+100%） 小组件整体结构保持一致 端不同页面布局不同。
如何判断不同的设备，根据 `navigator.userAgent`

## 富文本

### 原生 js 实现富文本

原生实现富文本的三个关键特性：

1. 全局属性 `contenteditable` 是一个枚举属性，表示元素是否可被用户编辑。 如果可以，浏览器会修改元素的部件以允许编辑。
2. `Window.getSelection` 返回一个 `Selection` 对象，表示用户选择的文本范围或光标的当前位置。
3. 当一个 HTML 文档切换到设计模式时，`document` 暴露 `execCommand` 方法，该方法允许运行命令来操纵可编辑内容区域的元素。（特性已经被废弃，已经不建议使用）

不使用 `execCommand` 的设计:

1. 借助 HTMLcontenteditable，好处是配合已有的浏览器光标、选区方面的支持。
2. 将输入的内容转换为内部文档模型（在 dom 层上进行一层抽象，利用 js 结构对象来描述视图和操作），防止直接操作 dom，影响性能。

### Draft.js

Draft.js 是 facebook 推出的用于 React 的富文本编辑器框架，是通过 Immutable.js 来保存数据的。不是一个开箱即用的富文本编辑器，而是一个构建自己的富文本编辑器的工具库，能实现什么功能，全靠自己动手扩展。

> contenteditable 中 DOM = State ，这里的 State 指存储用户输入的内容，为 html 格式；从用户操作发起到数据修改整个过程都由浏览器控制，但是各浏览器存在实现差异，造成 State 的结果不一致，兼容性问题多。contenteditable 又有很多原生能力，速度快且支持所有的浏览器、如光标与选区、输入法事件等。最终 draft-js 通过自定义 State，抛弃掉原生提供的 html 形式的 State，通过 contenteditable 提供的能力负责文字排版与用户事件接收，定义一套 op(Operation) 来修改 State ，同时把数据模型通过 react 渲染到 html 中，达到 _controlled contenteditable_。
